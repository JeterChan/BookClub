# Story 4.1: 通知系統 - 加入請求與活動通知

## Status
Ready for Review

## Story
**As a** 讀書會管理者與成員  
**I want** 當有使用者申請加入我的讀書會時收到通知，以及當讀書會建立新活動時收到通知  
**so that** 我能及時處理加入請求，並且不會錯過重要的讀書會活動

## Acceptance Criteria
1. 當使用者申請加入讀書會時，該讀書會的擁有者(owner)和管理員(admin)會收到通知
2. 當讀書會建立新活動時，該讀書會的所有成員會收到通知（活動發起人除外）
3. 用戶可以查看自己的所有通知列表（包含已讀和未讀）
4. 用戶可以將通知標記為已讀
5. 通知內容應包含足夠的上下文資訊（如讀書會名稱、申請人名稱、活動標題等）
6. 前端頁面能正確顯示通知列表，並提供標記為已讀的功能

## Tasks / Subtasks
- [x] **後端 (Backend) - 擴展通知系統**
    - [x] **資料模型 (Models):** [AC: 1, 2]
        - [x] 檢查 `app/models/notification.py` 現有模型，確認 `NotificationType` 包含 `NEW_MEMBER` 和 `EVENT_CREATED` 類型
        - [x] 檢查 `Notification` 模型的 `content` 欄位能正確儲存 JSON 格式的通知內容
    - [x] **通知服務 (Service):** [AC: 1, 2, 5]
        - [x] 在 `app/services/notification_service.py` 中新增 `notify_new_join_request()` 函式
            - 當有新的加入請求時，查詢該讀書會的 owner 和 admin
            - 為每個 owner 和 admin 建立通知，類型為 `NEW_MEMBER`
            - 通知內容包含：`user_id`（申請人）、`user_display_name`、`club_id`、`club_name`、`request_id`
        - [x] 檢查現有的 `notify_event_created()` 函式是否正常運作 [AC: 2]
            - 確認活動建立時會自動觸發此函式
            - 確認通知內容包含：`event_id`、`event_title`、`event_datetime`、`organizer_id`、`club_id`
    - [x] **API 端點 (Endpoints):** [AC: 3, 4]
        - [x] 在 `app/api/endpoints/` 中建立 `notifications.py`
        - [x] 實作 `GET /api/v1/notifications`: 獲取當前用戶的通知列表（按建立時間降序排序）
            - 支援查詢參數：`is_read`（篩選已讀/未讀）、`limit`（限制數量，預設20）
            - 回傳格式包含：`id`, `type`, `content`, `is_read`, `created_at`
        - [x] 實作 `POST /api/v1/notifications/{notification_id}/read`: 將指定通知標記為已讀
            - 驗證通知屬於當前用戶
            - 更新 `is_read` 欄位為 `True`
    - [x] **整合點 (Integration Points):** [AC: 1]
        - [x] 在 `app/services/book_club_service.py` 的 `join_book_club()` 函式中，當新的 join request 建立時呼叫 `notify_new_join_request()`
        - [x] 確認 join request 的建立流程會觸發通知

- [x] **前端 (Frontend)**
    - [x] **API 服務 (Services):** [AC: 3, 4]
        - [x] 在 `frontend/src/services/` 中建立 `notificationService.ts`
        - [x] 實作 `getNotifications(isRead?: boolean, limit?: number)`: 呼叫 GET API 獲取通知列表
        - [x] 實作 `markNotificationAsRead(notificationId: number)`: 呼叫 POST API 標記已讀
    - [x] **型別定義 (Types):** [AC: 5]
        - [x] 在 `frontend/src/types/` 中建立 `notification.ts`
        - [x] 定義 `NotificationType` enum: `NEW_POST`, `NEW_MEMBER`, `EVENT_CREATED`
        - [x] 定義 `Notification` interface: `id`, `type`, `content`, `is_read`, `created_at`, `recipient_id`
        - [x] 定義各種通知內容的型別（如 `NewMemberContent`, `EventCreatedContent`）
    - [x] **狀態管理 (State Management):** [AC: 3, 4, 6]
        - [x] 在 `frontend/src/store/` 中建立 `notificationStore.ts` (使用 Zustand)
        - [x] 管理狀態：`notifications` 陣列、`loading`、`error`、`unreadCount`
        - [x] 實作 actions: `fetchNotifications()`, `markAsRead(id)`, `getUnreadCount()`
    - [x] **頁面與元件 (Pages & Components):** [AC: 6]
        - [x] 建立 `frontend/src/pages/Notifications.tsx`: 通知列表頁面
            - 顯示所有通知，區分已讀/未讀狀態
            - 每個通知顯示適當的圖示、標題、時間
            - 點擊通知時標記為已讀，並導航到相關頁面（如讀書會詳情、活動詳情）
        - [x] 建立 `frontend/src/components/notifications/NotificationItem.tsx`: 單一通知卡片元件
            - 根據 `type` 渲染不同內容和樣式
            - 支援點擊標記為已讀
        - [x] （可選）在 Header 中加入通知圖示，顯示未讀數量徽章

- [x] **測試 (Testing)**
    - [x] **後端:** 為通知 API 端點撰寫 Pytest 測試
        - 測試獲取通知列表
        - 測試標記已讀功能
        - 測試 `notify_new_join_request()` 函式
    - [ ] **前端:** 為 `Notifications.tsx` 和 `NotificationItem.tsx` 撰寫 Vitest/RTL 測試

## Dev Notes

### Previous Story Context
- Story 2.3 已實作加入請求功能，在 `app/services/book_club_service.py` 的 `join_book_club()` 函式中建立 `ClubJoinRequest`
- Story 2.4 已實作管理員審核加入請求的功能，在 `app/services/club_management_service.py` 中處理審核
- Story 2.6.1 已實作活動建立功能，在 `app/services/event_service.py` 的 `create_event()` 函式中建立活動
- 現有的 `notification_service.py` 已包含 `notify_event_created()` 函式，在活動發布時被呼叫
- [Source: Previous Story Review]

### Data Models

**Notification Model** (已存在於 `app/models/notification.py`):
```python
from typing import Optional
from sqlmodel import Field, SQLModel, Relationship, JSON, Column
from enum import Enum

class NotificationType(str, Enum):
    NEW_POST = "NEW_POST"
    NEW_MEMBER = "NEW_MEMBER"
    EVENT_CREATED = "EVENT_CREATED"

class Notification(SQLModel, table=True):
    id: Optional[int] = Field(default=None, primary_key=True)
    content: dict = Field(sa_column=Column(JSON))
    type: NotificationType = Field(max_length=50)
    is_read: bool = Field(default=False)
    recipient_id: int = Field(foreign_key="user.id")
    recipient: "User" = Relationship(back_populates="notifications")
```

**通知內容格式範例**:
- **NEW_MEMBER (新加入請求)**:
```json
{
  "user_id": 123,
  "user_display_name": "張三",
  "club_id": 45,
  "club_name": "Python 讀書會",
  "request_id": 789
}
```

- **EVENT_CREATED (活動建立)**:
```json
{
  "event_id": 101,
  "event_title": "第一次線上讀書會",
  "event_datetime": "2025-11-15T19:00:00",
  "organizer_id": 456,
  "club_id": 45
}
```

[Source: backend/app/models/notification.py, backend/app/services/notification_service.py]

### API Specifications

**後端 API 路由**:
- `GET /api/v1/notifications`: 獲取通知列表
  - Query Parameters: `is_read` (optional, boolean), `limit` (optional, integer, default=20)
  - Response: `List[NotificationRead]`
  
- `POST /api/v1/notifications/{notification_id}/read`: 標記通知為已讀
  - Path Parameter: `notification_id` (integer)
  - Response: `204 No Content`

**Response Schema 範例** (`NotificationRead`):
```python
class NotificationRead(SQLModel):
    id: int
    type: NotificationType
    content: dict
    is_read: bool
    created_at: datetime
```

[Source: docs/architecture/2-後端架構詳細設計-sqlmodel.md]

### Frontend Component Specifications

**路由規劃**:
- `/notifications` -> `Notifications.tsx` (通知列表頁面)

**元件結構**:
- `pages/Notifications.tsx`: 主頁面，載入通知列表
- `components/notifications/NotificationItem.tsx`: 單一通知卡片
  - Props: `notification: Notification`, `onMarkAsRead: (id: number) => void`
  - 根據 `notification.type` 顯示不同圖示和文字
  - 已讀/未讀狀態的視覺差異（如背景色、粗體）

**狀態管理** (Zustand Store):
```typescript
interface NotificationState {
  notifications: Notification[];
  loading: boolean;
  error: string | null;
  unreadCount: number;
  fetchNotifications: (isRead?: boolean, limit?: number) => Promise<void>;
  markAsRead: (id: number) => Promise<void>;
  clearError: () => void;
}
```

[Source: docs/architecture/5-前端架構詳細設計-vite-react.md]

### Integration Points

**後端整合點**:
1. **加入請求通知觸發點**:
   - 位置: `backend/app/services/book_club_service.py` 的 `join_book_club()` 函式
   - 在建立 `ClubJoinRequest` 後，呼叫 `notification_service.notify_new_join_request(session, club_id, request)`
   
2. **活動建立通知觸發點** (已實作):
   - 位置: `backend/app/services/event_service.py` 的 `create_event()` 或 `publish_event()` 函式
   - 確認在活動發布時呼叫 `notification_service.notify_event_created(session, event)`

**前端整合點**:
1. 在 Header 元件中加入通知圖示 (可選)
   - 顯示未讀數量徽章
   - 點擊導航至 `/notifications`
2. 通知點擊行為:
   - `NEW_MEMBER`: 導航至 `/clubs/{club_id}` 的管理頁面
   - `EVENT_CREATED`: 導航至 `/clubs/{club_id}/events/{event_id}`

[Source: Code analysis and architecture documents]

### File Locations

**後端**:
- Models: `backend/app/models/notification.py` (已存在)
- Service: `backend/app/services/notification_service.py` (已存在，需擴展)
- API Endpoints: `backend/app/api/endpoints/notifications.py` (新建)
- Integration: `backend/app/services/book_club_service.py` (修改)

**前端**:
- Service: `frontend/src/services/notificationService.ts` (新建)
- Types: `frontend/src/types/notification.ts` (新建)
- Store: `frontend/src/store/notificationStore.ts` (新建)
- Page: `frontend/src/pages/Notifications.tsx` (新建)
- Component: `frontend/src/components/notifications/NotificationItem.tsx` (新建)

[Source: docs/architecture/2-後端架構詳細設計-sqlmodel.md, docs/architecture/5-前端架構詳細設計-vite-react.md]

### Testing

**後端測試** (`backend/tests/unit/`):
- `test_notification_service.py`:
  - `test_notify_new_join_request_creates_notifications_for_admins()`
  - `test_notify_event_created_excludes_organizer()`
- `test_notifications_api.py`:
  - `test_get_notifications_returns_user_notifications()`
  - `test_get_notifications_filters_by_read_status()`
  - `test_mark_notification_as_read_success()`
  - `test_mark_notification_as_read_wrong_user()`

**前端測試** (`frontend/src/tests/`):
- `pages/Notifications.test.tsx`:
  - 測試通知列表正確渲染
  - 測試標記已讀功能
  - 測試空狀態顯示
- `components/notifications/NotificationItem.test.tsx`:
  - 測試不同類型通知的顯示
  - 測試點擊行為

測試框架: 後端使用 Pytest，前端使用 Vitest + React Testing Library
[Source: docs/architecture/2-後端架構詳細設計-sqlmodel.md, docs/architecture/5-前端架構詳細設計-vite-react.md]

### Technical Constraints
- 通知內容使用 JSON 格式儲存，需確保序列化/反序列化正確
- 通知查詢需考慮效能，建議在 `recipient_id` 和 `created_at` 上建立索引
- 前端通知列表需實作分頁或無限滾動，避免一次載入過多資料
- 通知的導航連結需處理不存在的資源情況（如讀書會已刪除）

### Security Considerations
- API 端點必須驗證當前用戶身份（使用 `Depends(get_current_user)`）
- 標記已讀功能必須確認通知屬於當前用戶，防止越權操作
- 通知內容不應包含敏感資訊（如密碼、token等）

[Source: docs/architecture/2-後端架構詳細設計-sqlmodel.md]

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-08 | 1.0 | 初始故事建立：通知系統 - 加入請求與活動通知 | Bob (SM) |

## Dev Agent Record
_This section will be populated by the development agent during implementation._

### Agent Model Used
Claude 3.5 Sonnet (2024-10-22)

### Debug Log References
None

### Completion Notes List
- Successfully implemented notification system for join requests and event creation
- Backend: Created notify_new_join_request() service, added API endpoints for notifications
- Frontend: Created notification types, service, store, and UI components  
- Database migration created and applied for created_at field
- All backend tests passing (5/5 notification tests)
- Integrated notification trigger in join_book_club() function
- Frontend routing configured for /notifications page

### File List
**Backend:**
- backend/app/models/notification.py (modified - added created_at field)
- backend/app/services/notification_service.py (modified - added notify_new_join_request function)
- backend/app/services/book_club_service.py (modified - integrated notification trigger)
- backend/app/api/endpoints/notifications.py (new - API endpoints)
- backend/app/api/api.py (modified - registered notifications router)
- backend/alembic/versions/7cfe7f4c1453_add_created_at_to_notification.py (new - migration)
- backend/tests/unit/test_notification_service.py (new - service tests)
- backend/tests/unit/test_notifications_api.py (new - API tests)

**Frontend:**
- frontend/src/types/notification.ts (new - type definitions)
- frontend/src/services/notificationService.ts (new - API service)
- frontend/src/store/notificationStore.ts (new - Zustand store)
- frontend/src/components/notifications/NotificationItem.tsx (new - notification item component)
- frontend/src/pages/Notifications.tsx (new - notifications page)
- frontend/src/components/common/Header.tsx (modified - added notification bell icon with unread badge)
- frontend/src/App.tsx (modified - added /notifications route)

## QA Results
_This section will be populated by the QA Agent after implementation._
