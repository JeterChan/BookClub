# Story 1.2: 便捷登入體驗

**Status**: Approved

---

## Story

**As a** 已註冊的平台用戶,
**I want** 能夠快速且安全地登入我的帳號,
**so that** 存取我的個人資料和參與讀書會活動

---

## Acceptance Criteria

1. 用戶可以使用註冊的 Email 和密碼登入
2. 系統提供「記住我」選項延長登入狀態
3. 登入失敗時提供明確的錯誤訊息
4. 多次登入失敗會觸發帳號保護機制
5. 登入成功後導向個人儀表板

---

## Dev Notes

### 技術棧 (Tech Stack)
- **後端**: Python 3.11+, FastAPI
- **ORM**: SQLModel
- **密碼驗證**: `bcrypt` (via existing `security.py`)
- **JWT**: `python-jose[cryptography]` for token generation
- **資料驗證**: Pydantic (由 SQLModel 內建)
- *[Source: docs/architecture/1-架構概覽-v40.md]*

### 專案結構 (Project Structure)
遵循 FastAPI 專案結構，所有新的後端程式碼應建立在 `/backend/app/` 目錄下。
- *[Source: docs/architecture/2-後端架構詳細設計-sqlmodel.md#fastapi-專案結構-v40]*

### Previous Story Insights (Story 1.1)
- ✅ User model已完成，包含 `email`, `password_hash`, `display_name`
- ✅ `UserService.get_by_email()` 方法已實作，可用於查詢用戶
- ✅ `security.py` 已實作 `hash_password()` 和 `verify_password()` 函式
- ✅ 資料庫連線透過 `app/db/session.py` 的 `get_session()` 提供
- ⚠️ 注意：需要新增 JWT token 支援，這在 Story 1.1 中未實作
- *[Source: docs/stories/1.1.new-user-registration.md#dev-agent-record]*

### 資料模型 (Data Models)
Story 1.2 將使用現有的 `User` model 和新的 login schemas：

**現有的 `backend/app/models/user.py`:**
- `User`: 資料庫模型，包含 `id`, `email`, `password_hash`, `is_active` 等欄位
- `UserRead`: API 輸出模型，包含基本用戶資訊但不含密碼

**需要新增的 Login Schemas (`backend/app/models/user.py`):**
```python
class UserLogin(SQLModel):
    email: str
    password: str
    remember_me: bool = False

class Token(SQLModel):
    access_token: str
    token_type: str = "bearer"
```
- *[Source: docs/architecture/2-後端架構詳細設計-sqlmodel.md#資料模型與-api-schema-sqlmodel-範例]*

### API 規格 (API Specifications)
- **Endpoint**: `POST /api/auth/login`
- **Request Body**: 符合 `UserLogin` schema
  ```json
  {
    "email": "user@example.com",
    "password": "SecurePass123",
    "remember_me": false
  }
  ```
- **Success Response (200)**: 符合 `Token` schema
  ```json
  {
    "access_token": "eyJhbGc...",
    "token_type": "bearer"
  }
  ```
- **Error Responses**:
  - `401 Unauthorized`: `{"detail": "Incorrect email or password"}`
  - `401 Unauthorized`: `{"detail": "Account is locked due to multiple failed login attempts"}`
  - `403 Forbidden`: `{"detail": "Account is inactive"}`
- *[Source: docs/architecture/2-後端架構詳細設計-sqlmodel.md#restful-api-設計範例-fastapi-sqlmodel]*

### JWT Token Configuration
需要在 `backend/app/core/security.py` 新增 JWT token 處理：
- **Algorithm**: HS256
- **Secret Key**: 從環境變數 `SECRET_KEY` 讀取
- **Access Token Expiration**: 
  - Default: 30 minutes
  - With "remember_me": 7 days
- **Token Payload**: 應包含 `sub` (user email), `exp` (expiration)

### 帳號保護機制 (Account Protection)
針對 AC 4 (多次登入失敗觸發保護)，建議實作簡易的失敗計數：
- 在 `User` model 新增 `failed_login_attempts` 和 `locked_until` 欄位
- 5 次失敗後鎖定帳號 15 分鐘
- 成功登入後重置失敗計數

**需要的資料庫遷移:**
```python
# 在 User model 新增欄位
failed_login_attempts: int = Field(default=0)
locked_until: Optional[datetime] = Field(default=None)
```
- *[Note: 這需要產生新的 Alembic migration]*

### File Locations
基於專案結構，需要修改或新增以下檔案：
- **修改**: `backend/app/models/user.py` - 新增 Login schemas 和保護欄位
- **修改**: `backend/app/core/security.py` - 新增 JWT token 函式
- **修改**: `backend/app/services/user_service.py` - 新增 login 和保護機制方法
- **新增**: `backend/app/api/endpoints/auth.py` - 新增 `/login` endpoint
- **修改**: `backend/requirements.txt` - 新增 `python-jose[cryptography]`
- **修改**: `backend/.env` - 新增 `SECRET_KEY` 環境變數
- *[Source: docs/architecture/2-後端架構詳細設計-sqlmodel.md#fastapi-專案結構-v40]*

### 依賴項 (Dependencies)
需要在 `backend/requirements.txt` 新增：
```
python-jose[cryptography]>=3.3.0
```

### Testing Requirements
根據 Story 1.1 的測試模式，本 Story 的測試將由 QA Agent 處理。測試應涵蓋：
- 成功登入場景 (AC 1, 5)
- "記住我" 功能與 token 有效期 (AC 2)
- 錯誤訊息驗證 (AC 3)
- 帳號鎖定機制 (AC 4)
- 非活躍帳號登入拒絕

---

## Tasks / Subtasks

**NOTE FOR DEV AGENT:** Some foundational work from Story 1.1 is already in place. Focus on implementing the login-specific functionality.

1.  **[x] 更新 User Model 新增保護機制欄位 (AC: 4)**
    - [x] 在 `backend/app/models/user.py` 的 `User` class 中新增 `failed_login_attempts: int` (預設 0)
    - [x] 在 `User` class 中新增 `locked_until: Optional[datetime]` (預設 None)
    - [x] 新增 `UserLogin` schema class (email, password, remember_me)
    - [x] 新增 `Token` schema class (access_token, token_type)

2.  **[x] 建立資料庫遷移 (AC: 4)**
    - [x] 啟動 Docker 環境 (`docker-compose up -d`)
    - [x] 進入 `api` 容器 (`docker-compose exec api bash`)
    - [x] 執行 `alembic revision --autogenerate -m "Add login protection fields to user"`
    - [x] 執行 `alembic upgrade head` 套用遷移

3.  **[x] 擴展 Security 模組新增 JWT 支援 (AC: 1, 2)**
    - [x] 在 `backend/requirements.txt` 新增 `python-jose[cryptography]>=3.3.0`
    - [x] 重新建置 Docker image (`docker-compose build`)
    - [x] 在 `backend/.env` 新增 `SECRET_KEY` 環境變數 (使用強隨機字串)
    - [x] 在 `backend/app/core/security.py` 新增 `create_access_token(data: dict, expires_delta: Optional[timedelta])` 函式
    - [x] 在 `security.py` 新增 `decode_access_token(token: str)` 函式

4.  **[x] 擴展 UserService 新增登入邏輯 (AC: 1, 3, 4)**
    - [x] 在 `backend/app/services/user_service.py` 新增 `authenticate(session, email, password)` 方法
    - [x] 實作帳號鎖定檢查邏輯 (檢查 `locked_until` 是否過期)
    - [x] 實作密碼驗證 (使用 `verify_password`)
    - [x] 實作失敗計數遞增邏輯 (達到 5 次時設定 `locked_until` 為當前時間 + 15 分鐘)
    - [x] 實作成功登入時重置 `failed_login_attempts` 為 0

5.  **[x] 實作登入 API 端點 (AC: 1, 2, 3, 4, 5)**
    - [x] 在 `backend/app/api/endpoints/auth.py` 新增 `POST /login` 端點
    - [x] 呼叫 `UserService.authenticate()` 進行驗證
    - [x] 根據 `remember_me` 設定不同的 token 有效期 (30 分鐘 vs 7 天)
    - [x] 返回 `Token` response 包含 JWT access token
    - [x] 實作適當的錯誤處理 (401 for 錯誤密碼, 401 for 鎖定, 403 for 非活躍)
    - [x] 確保 auth router 已在 `api.py` 中註冊 (應該在 Story 1.1 已完成)

6.  **[ ] 撰寫測試 (AC: 1, 2, 3, 4, 5) - SKIP THIS TASK**
    - [ ] **NOTE:** This task will be handled by the QA Agent. Do not implement any tests.

---

## Dev Agent Record

### Agent Model Used
- GitHub Copilot (Claude Sonnet 4.5)

### Debug Log References
- ⚠️ 資料庫遷移初次失敗：新增 NOT NULL 欄位到已有資料的表格需要使用 `server_default`
  - 解決方案：修改遷移腳本，為 `failed_login_attempts` 欄位添加 `server_default='0'`
- ⚠️ requirements.txt 格式問題：使用 echo 命令時 bcrypt 與新依賴連在一起
  - 解決方案：手動修正 requirements.txt 檔案格式

### Completion Notes
- ✅ 所有驗收標準 (AC 1-5) 均已實現並測試通過
- ✅ AC 1：用戶可使用 Email 和密碼成功登入，返回 JWT token
- ✅ AC 2：「記住我」功能正常運作
  - `remember_me: false` → token 有效期 30 分鐘
  - `remember_me: true` → token 有效期 7 天
- ✅ AC 3：登入失敗提供明確錯誤訊息
  - 錯誤的 email 或密碼：`"Incorrect email or password"`
  - 帳號被鎖定：`"Account is locked due to multiple failed login attempts"`
  - 帳號非活躍：`"Account is inactive"`
- ✅ AC 4：帳號保護機制已實作
  - 5 次失敗登入後鎖定帳號 15 分鐘
  - 成功登入後重置失敗計數
  - 鎖定期過後自動解鎖
- ✅ AC 5：API 端點正確實作（登入成功後前端可導向個人儀表板）
- ✅ JWT token 實作：使用 HS256 演算法，payload 包含 user email
- ✅ 資料庫 schema 已更新：新增 `failed_login_attempts` 和 `locked_until` 欄位

### File List
#### 新建檔案
- `backend/alembic/versions/7c65718e9851_add_login_protection_fields_to_user.py` - 資料庫遷移腳本

#### 修改檔案
- `backend/app/models/user.py` - 新增 `failed_login_attempts`、`locked_until` 欄位，以及 `UserLogin` 和 `Token` schemas
- `backend/app/core/security.py` - 新增 JWT token 功能：`create_access_token()` 和 `decode_access_token()`
- `backend/app/services/user_service.py` - 新增 `authenticate()` 方法，實作登入驗證和帳號保護邏輯
- `backend/app/api/endpoints/auth.py` - 新增 `POST /login` 端點
- `backend/requirements.txt` - 新增 `python-jose[cryptography]>=3.3.0` 依賴
- `backend/.env` - 新增 `SECRET_KEY` 環境變數

### Change Log
- 2025-10-15: 完成所有任務，登入 API 已部署並測試通過

### Status
Ready for Review

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-15 | 1.0 | Initial story creation | Scrum Master (Bob) |
