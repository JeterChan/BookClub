# Story 3.2: 讀書會內部討論區

## Status
In Progress

## Story
**As a** 一個讀書會的成員
**I want** 一個專屬的討論區，可以在其中發表主題、提問和回覆
**so that** 與其他成員就書籍內容進行深入、非同步的交流

## Acceptance Criteria
1.  每個讀書會都有一個獨立的、僅限成員訪問的討論區。
2.  成員可以建立新的討論主題，包含標題和內容。
3.  成員可以回覆任何討論主題，形成對話串。
4.  發文和回覆支援基本的文字格式（如粗體、斜體、清單）和引用功能。
5.  用戶會收到關於他們所參與的討論串的新回覆通知 (此項的實作將推遲到 Epic 4)。

## Tasks / Subtasks
- [x] **後端 (Backend)**
    - [x] **資料庫 (Database):**
        - [x] **Alembic 遷移:** 建立新的遷移腳本，新增 `DiscussionTopic` 和 `DiscussionComment` 資料表。 [AC: 1, 2, 3]
            - `alembic revision --autogenerate -m "Add discussion topic and comment models"`
    - [x] **資料模型 (Models):**
        - [x] 在 `app/models/` 中建立 `discussion.py`，定義 `DiscussionTopic` 和 `DiscussionComment` 的 SQLModel 模型。 [AC: 1, 2, 3]
    - [x] **API 端點 (Endpoints):**
        - [x] 在 `app/api/endpoints/` 中建立 `discussions.py` 來處理所有相關路由。
        - [x] 實作 `GET /api/v1/clubs/{club_id}/discussions`: 獲取該讀書會的所有討論主題列表。 [AC: 1]
        - [x] 實作 `POST /api/v1/clubs/{club_id}/discussions`: 允許成員建立新的討論主題。 [AC: 2]
        - [x] 實作 `GET /api/v1/clubs/{club_id}/discussions/{topic_id}`: 獲取單一主題及其所有回覆。 [AC: 3]
        - [x] 實作 `POST /api/v1/clubs/{club_id}/discussions/{topic_id}/comments`: 允許成員對主題發表回覆。 [AC: 3]
- [x] **前端 (Frontend)**
    - [x] **API 服務 (Services):**
        - [x] 在 `frontend/src/services/clubService.ts` 中新增上述四個 API 的請求函式。
    - [x] **狀態管理 (State Management):**
        - [x] 擴充 `frontend/src/store/slices/clubSlice.ts`，加入管理討論主題和回覆的 state。
    - [x] **頁面與元件 (Pages & Components):**
        - [x] **討論列表頁:** 建立 `frontend/src/pages/clubs/Discussions.tsx`，顯示所有主題列表。 [AC: 1]
        - [x] **新增主題頁:** 建立 `frontend/src/pages/clubs/DiscussionNew.tsx`，提供一個包含標題和內容輸入框的表單。 [AC: 2]
        - [x] **主題詳情頁:** 建立 `frontend/src/pages/clubs/DiscussionDetail.tsx`，顯示主題內容和所有回覆。 [AC: 3]
        - [x] **文字編輯器:** 整合一個輕量級的 React MarkDown 編輯器元件以支援基本格式化。 [AC: 4]
- [ ] **測試 (Testing)**
    - [x] **後端:** 為所有新增的 API 端點撰寫 Pytest 單元測試。
    - [ ] **前端:** 為 `Discussions.tsx` 和 `DiscussionDetail.tsx` 頁面撰寫 Vitest/RTL 單元測試。

## Dev Notes
### API Specifications
- 路由規劃完全遵循架構文件中的定義。
- `GET /api/v1/clubs/{club_id}/discussions`: 返回 `DiscussionTopic` 列表。
- `POST /api/v1/clubs/{club_id}/discussions`: 請求內文為 `{ "title": "string", "content": "string" }`。
- `GET /api/v1/clubs/{club_id}/discussions/{topic_id}`: 返回 `DiscussionTopic` 及其 `comments` 列表。
- `POST /api/v1/clubs/{club_id}/discussions/{topic_id}/comments`: 請求內文為 `{ "content": "string" }`。
- [Source: docs/architecture/2-後端架構詳細設計-sqlmodel.md#api-路由規劃]

### Data Models
- **`DiscussionTopic` Model (`app/models/discussion.py`):**
  ```python
  from typing import List, Optional
  from sqlmodel import Field, SQLModel, Relationship

  class DiscussionTopicBase(SQLModel):
      title: str
      content: str

  class DiscussionTopic(DiscussionTopicBase, table=True):
      id: Optional[int] = Field(default=None, primary_key=True)
      club_id: int = Field(foreign_key="bookclub.id")
      owner_id: int = Field(foreign_key="user.id")
      
      comments: List["DiscussionComment"] = Relationship(back_populates="topic")
  ```
- **`DiscussionComment` Model (`app/models/discussion.py`):**
  ```python
  from typing import Optional
  from sqlmodel import Field, SQLModel, Relationship

  class DiscussionCommentBase(SQLModel):
      content: str

  class DiscussionComment(DiscussionCommentBase, table=True):
      id: Optional[int] = Field(default=None, primary_key=True)
      topic_id: int = Field(foreign_key="discussiontopic.id")
      owner_id: int = Field(foreign_key="user.id")
      
      topic: "DiscussionTopic" = Relationship(back_populates="comments")
  ```
- [Source: docs/architecture/2-後端架構詳細設計-sqlmodel.md]

### Frontend Component Specifications
- **頁面路由:**
    - `/clubs/:clubId/discussions` -> `Discussions.tsx`
    - `/clubs/:clubId/discussions/new` -> `DiscussionNew.tsx`
    - `/clubs/:clubId/discussions/:topicId` -> `DiscussionDetail.tsx`
- **文字格式化 [AC: 4]:**
    - 建議使用如 `react-markdown` 搭配 `remark-gfm` 來渲染內容，並使用一個簡單的 Markdown 編輯器（如 `react-simplemde-editor` 或自訂帶有按鈕的 `textarea`）來輸入。
- [Source: docs/architecture/5-前端架構詳細設計-vite-react.md]

### File Locations
- **Backend Models & API:** `backend/app/models/discussion.py`, `backend/app/api/endpoints/discussions.py`
- **Frontend Pages:** `frontend/src/pages/clubs/Discussions.tsx`, `frontend/src/pages/clubs/DiscussionNew.tsx`, `frontend/src/pages/clubs/DiscussionDetail.tsx`
- [Source: docs/architecture/2-後端架構詳細設計-sqlmodel.md, docs/architecture/5-前端架構詳細設計-vite-react.md]
