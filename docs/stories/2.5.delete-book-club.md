# Story 2.5: 刪除讀書會

**Status:** Done
**Epic:** Epic 2 - 讀書會管理與探索
**Story Points:** 3
**Priority:** 低
**Depends On:** Story 2.4

---

## Story

**作為** 一個讀書會的「擁有者」
**我想要** 刪除我建立的讀書會
**以便於** 我可以移除不再活躍或已結束的社群

---

## Acceptance Criteria

1.  **AC1 - 僅限擁有者刪除:** 只有讀書會的「擁有者」可以在讀書會設定頁面看到並使用刪除功能。
2.  **AC2 - 二次確認:** 點擊刪除按鈕後，必須彈出一個強制性的二次確認對話框（Modal），明確警告「此操作不可逆，將永久刪除所有相關資料」。
3.  **AC3 - 後端驗證:** 後端 API (`DELETE /api/clubs/{clubId}`) 必須嚴格驗證發出請求的使用者是否為該讀書會的擁有者。
4.  **AC4 - 成功刪除後重新導向:** 成功刪除讀書會後，前端應將使用者重新導向至讀書會探索頁面 (`/clubs`)，並顯示一個成功的提示訊息（toast）。

---

## Tasks / Subtasks

### Task 1: Backend
- [x] 1.1 **(AC3)** 在 `backend/app/api/endpoints/book_clubs.py` 中新增 `DELETE /api/clubs/{club_id}` 端點。
- [x] 1.2 **(AC3)** 此端點需使用 `club_owner_required` 權限依賴項來確保只有擁有者可以存取。
- [x] 1.3 **(AC3)** 在 `backend/app/services/club_management_service.py` 中新增 `delete_club` 服務函式，負責執行刪除讀書會的業務邏輯。
- [x] 1.4 **(AC3)** `delete_club` 函式應刪除 `BookClub` 記錄以及所有相關的 `BookClubMember` 和 `ClubJoinRequest` 記錄。
- [x] 1.5 **(Backend Testing)** 在 `backend/tests/integration/test_club_management_api.py` 中為 `DELETE /api/clubs/{club_id}` 端點新增整合測試，涵蓋成功刪除、非擁有者試圖刪除（預期 403 錯誤）等情境。

### Task 2: Frontend
- [x] 2.1 **(AC1)** 在 `frontend/src/pages/clubs/ClubSettings.tsx` 頁面中，新增一個「危險區域」，其中包含「刪除讀書會」按鈕。此區塊僅在當前登入使用者為讀書會擁有者時顯示。
- [x] 2.2 **(AC2)** 建立一個可重用的 `ConfirmationModal.tsx` 元件，用於二次確認操作。
- [x] 2.3 **(AC2)** 點擊「刪除讀書會」按鈕時，觸發 `ConfirmationModal`，顯示警告訊息。
- [x] 2.4 **(AC4)** 在 `frontend/src/services/clubManagementService.ts` 中新增 `deleteClub` 函式，呼叫 `DELETE /api/clubs/{clubId}` API。
- [x] 2.5 **(AC4)** 在 `frontend/src/store/clubManagementStore.ts` 中新增 `deleteClub` action，該 action 呼叫 service 層的函式，並在成功後處理頁面重新導向和 `toast` 通知的顯示。
- [x] 2.6 **(Frontend Testing)** 在 `frontend/src/store/__tests__/clubManagementStore.test.ts` 中為新的 `deleteClub` action 新增單元測試。
- [x] 2.7 **(Frontend Testing)** 為 `ClubSettings.tsx` 頁面建立新的測試檔案，測試「刪除」按鈕的條件渲染以及點擊後是否觸發確認對話框。

---

## Dev Notes

### Previous Story Insights
- **Testing Gaps**: Story 2.4 的 QA 審查發現後端和前端都存在測試覆蓋缺口和環境問題。本 Story 的實作應確保為所有新功能（特別是後端權限）撰寫完整且通過的測試。 [Source: Story 2.4 QA Results]

### API Specifications
- **Endpoint**: `DELETE /api/clubs/{clubId}`
  - **功能**: 永久刪除一個讀書會及其所有相關資料。
  - **認證**: **必須**，且使用者必須是該讀書會的擁有者。應使用 `club_owner_required` 依賴項進行保護。
  - **成功回應**: `204 No Content`
  - **失敗回應**: `403 Forbidden` (非擁有者), `404 Not Found` (讀書會不存在)
  - [Source: `docs/architecture/2-後端架構詳細設計-sqlmodel.md`]

### Component Specifications
- **`ClubSettings.tsx`**:
  - 在頁面底部新增一個視覺上區分開的「危險區域」（Danger Zone）。
  - 在此區域內，僅當 `detailClub.membership_status === 'owner'` 時，才渲染「刪除讀書會」按鈕。
- **`ConfirmationModal.tsx`**:
  - 應接受 `isOpen`, `onClose`, `onConfirm`, `title`, `message` 等 props。
  - 用於顯示一個置中的模態對話框，包含明確的警告標題、訊息以及「確認」和「取消」按鈕。

### File Locations
- **Backend Endpoint**: `backend/app/api/endpoints/book_clubs.py` (在現有檔案中新增 `DELETE` 路由)
- **Backend Service**: `backend/app/services/club_management_service.py` (在現有檔案中新增 `delete_club` 方法)
- **Frontend Component**: `frontend/src/components/common/ConfirmationModal.tsx` (建議新建)
- **Frontend Service**: `frontend/src/services/clubManagementService.ts` (在現有檔案中新增 `deleteClub` 函式)
- **Frontend Store**: `frontend/src/store/clubManagementStore.ts` (在現有檔案中新增 `deleteClub` action)

### Testing Requirements
- **Backend**:
  - **權限測試**: 必須在 `test_club_management_api.py` 中新增測試，驗證只有擁有者能成功呼叫刪除端點。需包含管理員和普通成員呼叫時返回 403 的測試案例。
- **Frontend**:
  - **條件渲染測試**: 需測試 `ClubSettings.tsx` 中，「刪除」按鈕是否僅對擁有者可見。
  - **互動測試**: 需測試點擊刪除按鈕後，`ConfirmationModal` 是否正確顯示，以及點擊「確認」後是否呼叫 `deleteClub` action。

---

## Dev Agent Record

### File List
- `backend/app/api/endpoints/book_clubs.py`
- `backend/app/services/club_management_service.py`
- `backend/tests/integration/test_club_management_api.py`
- `frontend/src/components/common/ConfirmationModal.tsx`
- `frontend/src/pages/clubs/ClubSettings.tsx`
- `frontend/src/pages/clubs/__tests__/ClubSettings.test.tsx`
- `frontend/src/services/clubManagementService.ts`
- `frontend/src/store/clubManagementStore.ts`
- `frontend/src/store/__tests__/clubManagementStore.test.ts`
