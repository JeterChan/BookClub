# Story 2.1: 建立讀書會 (Create)

**Status**: Draft

---

## Story

**As a** 平台用戶  
**I want** 建立一個新的讀書會  
**so that** 我可以組織和管理一個圍繞特定書籍或主題的社群

---

## Acceptance Criteria

1. [ ] 用戶可以設定讀書會名稱（必填，50字元內）、簡介（選填，500字元內）、封面圖片（選填）
2. [ ] 用戶可以將讀書會設定為「公開」（任何人可見可加入）或「私密」（僅限邀請）
3. [ ] 建立成功後，建立者自動成為該讀書會的「擁有者」
4. [ ] 需要為讀書會設定至少一個主題標籤，以利於分類和搜尋

---

## Tasks / Subtasks

### Task 1: 擴充 BookClub Model 支援標籤系統 (AC: 1, 4)
- [ ] 建立 `ClubTag` 模型 (類似 InterestTag 的結構)
  - [ ] 欄位：`id`, `name`, `is_predefined`, `created_at`
- [ ] 建立 `BookClubTagLink` 中間表連接 BookClub 和 ClubTag (多對多關係)
  - [ ] 欄位：`book_club_id`, `tag_id`, `created_at`
- [ ] 更新 `BookClub` 模型新增關係
  - [ ] 新增 `tags: List[ClubTag]` relationship
  - [ ] 新增 `cover_image_url: Optional[str]` 欄位用於封面圖片
- [ ] 建立 Alembic migration 更新資料庫 schema
- [ ] 預先建立預設標籤資料 (如：文學、商業、科技、歷史等)

### Task 2: 建立 BookClub API Schemas (AC: 1, 2, 4)
- [ ] 在 `backend/app/models/book_club.py` 新增 API schemas:
  - [ ] `BookClubCreate` schema
    - 欄位：`name` (必填, max_length=50), `description` (選填, max_length=500)
    - 欄位：`visibility` (BookClubVisibility enum), `tag_ids` (List[int], 至少一個)
  - [ ] `BookClubRead` schema
    - 包含基本資訊 + `owner` (UserRead) + `tags` (List[ClubTagRead])
    - 包含 `member_count` (int) 欄位
  - [ ] `ClubTagRead` schema
  - [ ] `ClubTagCreate` schema
- [ ] 新增欄位驗證器
  - [ ] 驗證 name 長度 ≤ 50 字元
  - [ ] 驗證 description 長度 ≤ 500 字元
  - [ ] 驗證 tag_ids 至少包含一個標籤

### Task 3: 實作建立讀書會 Service 層邏輯 (AC: 1, 2, 3, 4)
- [ ] 建立 `backend/app/services/book_club_service.py`
  - [ ] 實作 `create_book_club()` 函數
    - 參數：`session`, `current_user`, `book_club_data`
    - 驗證所有 tag_ids 是否存在
    - 建立 BookClub 實例，設定 `owner_id = current_user.id`
    - 關聯標籤至讀書會 (透過 BookClubTagLink)
    - 自動建立 BookClubMember 記錄 (role=OWNER)
    - 返回完整的 BookClubRead 資料
  - [ ] 實作 `get_available_tags()` 函數
    - 返回所有可用的標籤列表

### Task 4: 實作建立讀書會 API 端點 (AC: 1, 2, 3, 4)
- [ ] 建立 `backend/app/api/endpoints/book_clubs.py`
  - [ ] `POST /api/v1/clubs` 端點 (需認證)
    - 接收 `BookClubCreate` 資料
    - 呼叫 `book_club_service.create_book_club()`
    - 返回 `BookClubRead` 資料 (status_code=201)
    - 錯誤處理：標籤不存在、驗證失敗
  - [ ] `GET /api/v1/clubs/tags` 端點
    - 返回所有可用標籤列表
    - 不需認證（公開端點）
- [ ] 在 `backend/app/api/api.py` 註冊 book_clubs router

### Task 5: 實作封面圖片上傳功能 (AC: 1)
- [ ] 擴充 `POST /api/v1/clubs` 端點支援 `cover_image_url` (選填)
- [ ] 或建立獨立的 `POST /api/v1/clubs/{club_id}/cover` 端點
  - [ ] 接收圖片檔案上傳 (multipart/form-data)
  - [ ] 驗證圖片格式 (JPG, PNG) 和大小 (最大 5MB)
  - [ ] 儲存至 `/backend/uploads/club_covers/` 資料夾
  - [ ] 更新 BookClub 的 `cover_image_url` 欄位
  - [ ] 返回圖片 URL
- [ ] 實作圖片存取端點 `GET /api/v1/uploads/club_covers/{filename}`

### Task 6: 前端 - 建立讀書會頁面實作 (AC: 1, 2, 4)
- [ ] 建立 `frontend/src/pages/clubs/ClubCreate.tsx` 頁面
  - [ ] 多步驟表單設計 (Step 1: 基本資訊, Step 2: 標籤選擇, Step 3: 封面上傳)
  - [ ] Step 1: 名稱、簡介、可見性設定
    - 輸入框驗證：名稱 ≤ 50 字元，簡介 ≤ 500 字元
    - Radio buttons 選擇 公開/私密
  - [ ] Step 2: 標籤選擇 (多選)
    - 從 API 載入可用標籤列表
    - Checkbox 或 Tag 選擇元件
    - 至少選擇一個標籤的驗證
  - [ ] Step 3: 封面圖片上傳 (選填)
    - 圖片預覽功能
    - 檔案大小和格式驗證
  - [ ] 表單提交按鈕與載入狀態
  - [ ] 成功後導向至新建立的讀書會詳細頁面 (`/clubs/{clubId}`)

### Task 7: 前端 - Book Club Service 層 (AC: 1, 2, 4)
- [ ] 建立 `frontend/src/services/bookClubService.ts`
  - [ ] `createBookClub(data: BookClubCreateRequest)` 函數
    - POST 請求至 `/api/v1/clubs`
    - 返回 BookClubRead 資料
  - [ ] `getAvailableTags()` 函數
    - GET 請求至 `/api/v1/clubs/tags`
  - [ ] `uploadClubCover(clubId: number, file: File)` 函數
    - POST 請求至 `/api/v1/clubs/{clubId}/cover`
- [ ] 建立 TypeScript 型別定義
  - [ ] `BookClubCreateRequest`, `BookClubRead`, `ClubTag` 等

### Task 8: 前端 - Redux Store 整合 (AC: 1, 2, 3, 4)
- [ ] 建立 `frontend/src/store/slices/bookClubSlice.ts`
  - [ ] State: `clubs`, `availableTags`, `loading`, `error`
  - [ ] Async thunks:
    - `createBookClubThunk`
    - `fetchAvailableTagsThunk`
  - [ ] Reducers: 更新 clubs 列表、處理載入狀態
- [ ] 在 ClubCreate 頁面中使用 Redux hooks
  - [ ] `useAppDispatch`, `useAppSelector`

### Task 9: 前端 - UI 元件與樣式 (AC: 1, 2, 4)
- [ ] 建立可重用的表單元件
  - [ ] `components/clubs/ClubFormInput.tsx` (名稱、簡介輸入)
  - [ ] `components/clubs/TagSelector.tsx` (標籤多選元件)
  - [ ] `components/clubs/ImageUploader.tsx` (圖片上傳元件)
  - [ ] `components/clubs/VisibilityToggle.tsx` (公開/私密切換)
- [ ] 套用 Tailwind CSS 樣式
  - [ ] 響應式設計 (手機/平板/桌面)
  - [ ] 符合設計系統規範 (主色調 #1E40AF)
  - [ ] 表單驗證錯誤提示樣式

### Task 10: 單元測試 (AC: All)
- [ ] **後端測試** (`tests/unit/test_book_club_service.py`)
  - [ ] 測試 `create_book_club()` 正常流程
  - [ ] 測試無效標籤 ID 的錯誤處理
  - [ ] 測試欄位驗證 (名稱過長、簡介過長等)
- [ ] **前端測試** (`src/test/ClubCreate.test.tsx`)
  - [ ] 測試表單輸入與驗證
  - [ ] 測試標籤選擇邏輯
  - [ ] 測試表單提交流程 (Mock API)

### Task 11: 整合測試 (AC: All)
- [ ] **完整建立讀書會流程測試** (`tests/integration/test_create_book_club.py`)
  - [ ] 測試認證用戶建立公開讀書會成功
  - [ ] 測試認證用戶建立私密讀書會成功
  - [ ] 測試自動成為擁有者 (BookClubMember role=OWNER)
  - [ ] 測試標籤關聯正確性
  - [ ] 測試未認證用戶無法建立讀書會 (401)
  - [ ] 測試缺少必填欄位的錯誤回應 (422)

---

## Dev Notes

### 資料模型設計

根據 `docs/architecture/2-後端架構詳細設計-sqlmodel.md`，本故事需要擴充現有的 BookClub 模型：

**現有結構** [Source: backend/app/models/book_club.py]:
```python
class BookClub(SQLModel, table=True):
    id: Optional[int] = Field(default=None, primary_key=True)
    name: str = Field(max_length=100, index=True)
    description: Optional[str] = Field(default=None, max_length=1000)
    visibility: BookClubVisibility = Field(default=BookClubVisibility.PUBLIC)
    owner_id: int = Field(foreign_key="user.id")
    owner: "User" = Relationship(back_populates="owned_clubs")
    members: List["BookClubMember"] = Relationship(back_populates="book_club")
```

**需要新增**:
1. **標籤系統** - 參考現有的 `InterestTag` 模型結構
   - `ClubTag` 模型 (類似 `InterestTag`)
   - `BookClubTagLink` 中間表 (類似 `UserInterestTag`)
   - BookClub 的 `tags` relationship
2. **封面圖片** - 新增 `cover_image_url` 欄位
3. **時間戳** - 新增 `created_at`, `updated_at` 欄位 (可選)

### API 端點設計

根據 `docs/architecture/2-後端架構詳細設計-sqlmodel.md#25-api-路由規劃`:

**Epic 2: 讀書會管理**
- `POST /api/v1/clubs`: 建立讀書會 ✅ (本故事實作)
- `GET /api/v1/clubs/tags`: 取得可用標籤 ✅ (本故事實作)
- `POST /api/v1/clubs/{clubId}/cover`: 上傳封面圖片 ✅ (本故事實作)

**認證要求**:
- 所有 `/api/v1/clubs` 的 POST 端點需要 JWT 認證
- 使用 `Depends(get_current_user)` 取得當前用戶

**回應格式**:
- 成功建立：201 Created + BookClubRead 資料
- 驗證錯誤：422 Unprocessable Entity
- 認證失敗：401 Unauthorized

### 前端頁面架構

根據 `docs/prd/4-uiux-設計目標.md`:

**建立讀書會頁面** (`/clubs/create`):
- 多步驟表單設計 (Step-by-step wizard)
- 響應式佈局：
  - 桌面版：居中卡片設計，最大寬度 1280px
  - 手機版：單欄全屏表單
- 設計系統組件使用：
  - 主要按鈕 (藍色 #1E40AF)
  - 表單輸入框 (統一樣式)
  - 卡片設計 (陰影效果、圓角)
  - Toast 通知 (成功/失敗提示)

**路由配置** [Source: docs/architecture/5-前端架構詳細設計-vite-react.md]:
```tsx
<Route path="/clubs/create" element={<PrivateRoute><ClubCreate /></PrivateRoute>} />
```

### 檔案上傳處理

**後端**:
- 上傳目錄：`/backend/uploads/club_covers/`
- 檔案命名：`{club_id}_{timestamp}.{ext}`
- 支援格式：JPG, PNG
- 大小限制：5MB
- 存取端點：`GET /api/v1/uploads/club_covers/{filename}`

**前端**:
- 使用 `<input type="file" accept="image/jpeg,image/png" />`
- 圖片預覽功能 (FileReader API)
- 上傳進度顯示 (可選)

### 測試標準

根據現有測試結構 [Source: backend/tests/conftest.py]:

**單元測試** (`tests/unit/test_book_club_service.py`):
- 使用 in-memory SQLite database
- Mock 外部依賴
- 測試邊界條件和錯誤處理

**整合測試** (`tests/integration/test_create_book_club.py`):
- 使用 TestClient 模擬完整 HTTP 請求
- 測試端到端流程
- 驗證資料庫狀態變更

**測試覆蓋率目標**: ≥ 80% (依據 PRD NFR1.6)

### 前一個故事的重要筆記

Story 1.7 (Google OAuth 登入與 Email 驗證機制) 已完成，實作了：
- JWT 認證機制完整運作
- `get_current_user` dependency 可直接使用
- 用戶模型包含完整的關係 (owned_clubs, memberships)

因此本故事可以直接依賴現有的認證系統，無需重新實作。

### 相關原始碼位置

**後端**:
- Models: `backend/app/models/`
  - `book_club.py` (需擴充)
  - `book_club_member.py` (已存在)
  - `interest_tag.py` (參考標籤實作)
- Services: `backend/app/services/` (需新增 `book_club_service.py`)
- API Endpoints: `backend/app/api/endpoints/` (需新增 `book_clubs.py`)
- Migrations: `backend/alembic/versions/`

**前端**:
- Pages: `frontend/src/pages/clubs/` (需新增 `ClubCreate.tsx`)
- Services: `frontend/src/services/` (需新增 `bookClubService.ts`)
- Store: `frontend/src/store/slices/` (需新增 `bookClubSlice.ts`)
- Components: `frontend/src/components/clubs/` (需新增多個元件)

### 技術約束

- **密碼雜湊**: bcrypt (由 `core.security` 提供)
- **JWT Token**: 使用現有的 `create_access_token` 函數
- **資料庫遷移**: 使用 Alembic
- **ORM**: SQLModel
- **前端狀態管理**: Redux Toolkit
- **前端樣式**: Tailwind CSS
- **圖示**: Heroicons 或 Lucide Icons

---

## Change Log

| Date       | Version | Description           | Author |
|------------|---------|----------------------|--------|
| 2025-10-24 | 1.0     | Story 初稿建立        | Bob (SM) |

---

## Dev Agent Record

_此區域由開發代理在實作過程中填寫_

### Agent Model Used

_待填寫_

### Debug Log References

_待填寫_

### Completion Notes List

_待填寫_

### File List

_待填寫_

---

## QA Results

_此區域由 QA 代理在完成測試後填寫_
