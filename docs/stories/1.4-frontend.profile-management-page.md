# Story 1.4-Frontend: 個人檔案管理頁面

**Status**: Ready for Review

---

## Story

**As a** 平台用戶,
**I want** 在網頁上管理和展示我的個人檔案,
**so that** 我可以更新個人資訊、上傳頭像、管理興趣標籤

---

## Acceptance Criteria

1. 個人檔案頁面路由為 `/profile`，需要登入才能訪問
2. 使用 Tab 導航設計，包含4個分頁（基本資料、頭像設定、興趣標籤、隱私設定）
3. **Tab 1 - 基本資料**: 編輯顯示名稱（2-50字元）、個人簡介（0-500字元）、顯示 Email（只讀）
4. **Tab 2 - 頭像設定**: 顯示當前頭像、上傳新頭像（JPG/PNG, 最大2MB）、移除頭像
5. **Tab 3 - 興趣標籤**: 顯示已選標籤、選擇預設標籤、新增自定義標籤（最多20個）
6. **Tab 4 - 隱私設定**: 控制個人檔案可見性、Email 顯示、讀書會顯示
7. 所有變更立即儲存並顯示成功訊息
8. 頭像上傳前預覽
9. 表單驗證錯誤即時提示
10. 響應式設計，支援手機、平板、桌面瀏覽

---

## Dev Notes

### Previous Story Insights

**From Backend Story 1.4:**
- ✅ 後端 API 已完成：
  - `GET /api/users/me/profile` - 獲取完整檔案
  - `PUT /api/users/me/profile` - 更新基本資料
  - `POST /api/users/me/avatar` - 上傳頭像
  - `GET /api/interest-tags` - 獲取所有標籤
  - `POST /api/interest-tags` - 創建自定義標籤
  - `POST /api/users/me/interest-tags` - 新增用戶標籤
  - `DELETE /api/users/me/interest-tags/{tag_id}` - 移除用戶標籤
- ✅ 頭像 URL 格式：`/uploads/avatars/{filename}`
- ✅ 興趣標籤最多20個，每個最多50字元
- ✅ 支援預設標籤和自定義標籤

**From Frontend Stories 1.1-1.3:**
- ✅ UI 元件（Input, Button, Checkbox）可重用
- ✅ Auth Store 提供用戶資訊
- ✅ Toast 通知系統已整合
- ✅ PrivateRoute 路由保護已實作

### API Specifications

**1. GET /api/users/me/profile**
- **Headers:** `Authorization: Bearer {access_token}`
- **Response:**
  ```typescript
  {
    id: number;
    email: string;
    display_name: string;
    bio: string | null;
    avatar_url: string | null;
    interest_tags: Array<{
      id: number;
      name: string;
      is_predefined: boolean;
    }>;
  }
  ```

**2. PUT /api/users/me/profile**
- **Headers:** `Authorization: Bearer {access_token}`
- **Body:**
  ```typescript
  {
    display_name?: string;  // 2-50字元
    bio?: string;           // 0-500字元
  }
  ```
- **Response:** 同 GET profile

**3. POST /api/users/me/avatar**
- **Headers:** `Authorization: Bearer {access_token}`, `Content-Type: multipart/form-data`
- **Body:** `FormData` with `file` field
- **Response:**
  ```typescript
  {
    avatar_url: string;
    message: string;
  }
  ```

**4. GET /api/interest-tags**
- **Query Params:** `predefined_only?: boolean`, `search?: string`
- **Response:**
  ```typescript
  Array<{
    id: number;
    name: string;
    is_predefined: boolean;
  }>
  ```

**5. POST /api/interest-tags**
- **Headers:** `Authorization: Bearer {access_token}`
- **Body:** `{ name: string }`
- **Response:** `InterestTag` object

**6. POST /api/users/me/interest-tags**
- **Headers:** `Authorization: Bearer {access_token}`
- **Body:** `{ tag_id: number }`
- **Response:** Array of user's tags

**7. DELETE /api/users/me/interest-tags/{tag_id}**
- **Headers:** `Authorization: Bearer {access_token}`
- **Response:** `{ message: string }`

### Component Specifications

**頁面元件:** `src/pages/Profile.tsx`

**子元件:**
1. `src/components/profile/BasicInfoTab.tsx` - 基本資料分頁
2. `src/components/profile/AvatarTab.tsx` - 頭像設定分頁
3. `src/components/profile/InterestTagsTab.tsx` - 興趣標籤分頁
4. `src/components/profile/PrivacyTab.tsx` - 隱私設定分頁
5. `src/components/ui/Tabs.tsx` - Tab 導航元件
6. `src/components/ui/FileUpload.tsx` - 檔案上傳元件
7. `src/components/ui/TagSelector.tsx` - 標籤選擇元件

### Tab Navigation Design

```tsx
// src/components/ui/Tabs.tsx
interface Tab {
  id: string;
  label: string;
  icon?: ReactNode;
  content: ReactNode;
}

<Tabs tabs={profileTabs} defaultTab="basic" />
```

**Tab 樣式:**
```tsx
<button className={`
  px-4 py-2 border-b-2 font-medium transition-colors
  ${active ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-600'}
  hover:text-blue-600
`}>
  {tab.label}
</button>
```

### Avatar Upload Flow

```typescript
// 1. 選擇檔案
const handleFileSelect = (e: ChangeEvent<HTMLInputElement>) => {
  const file = e.target.files?[0];
  if (!file) return;
  
  // 2. 驗證檔案
  if (!['image/jpeg', 'image/png'].includes(file.type)) {
    toast.error('僅支援 JPG 或 PNG 格式');
    return;
  }
  
  if (file.size > 2 * 1024 * 1024) {
    toast.error('檔案大小不可超過 2MB');
    return;
  }
  
  // 3. 預覽
  const reader = new FileReader();
  reader.onloadend = () => {
    setPreview(reader.result as string);
  };
  reader.readAsDataURL(file);
  
  setSelectedFile(file);
};

// 4. 上傳
const handleUpload = async () => {
  if (!selectedFile) return;
  
  const formData = new FormData();
  formData.append('file', selectedFile);
  
  try {
    const result = await profileService.uploadAvatar(formData);
    toast.success('頭像更新成功');
    // Update auth store
  } catch (error) {
    toast.error('頭像上傳失敗');
  }
};
```

### Interest Tags Management

**標籤選擇 UI:**
```tsx
// 顯示已選標籤
<div className="flex flex-wrap gap-2">
  {selectedTags.map(tag => (
    <div key={tag.id} className="flex items-center gap-2 px-3 py-1 bg-blue-100 text-blue-800 rounded-full">
      <span>{tag.name}</span>
      <button onClick={() => removeTag(tag.id)}>×</button>
    </div>
  ))}
</div>

// 預設標籤選擇
<div className="grid grid-cols-2 md:grid-cols-3 gap-2">
  {predefinedTags.map(tag => (
    <button 
      key={tag.id}
      onClick={() => addTag(tag.id)}
      disabled={selectedTags.length >= 20}
      className={`px-3 py-2 border rounded-lg ${isSelected ? 'bg-blue-600 text-white' : 'bg-white'}`}
    >
      {tag.name}
    </button>
  ))}
</div>

// 自定義標籤輸入
<div className="flex gap-2">
  <input 
    maxLength={50}
    placeholder="新增自定義標籤"
  />
  <button onClick={createCustomTag}>新增</button>
</div>
```

**20個標籤限制提示:**
```typescript
if (selectedTags.length >= 20) {
  toast.warning('最多只能選擇20個興趣標籤');
  return;
}
```

### Form Validation

**基本資料驗證 (Zod):**
```typescript
const basicInfoSchema = z.object({
  display_name: z.string()
    .min(2, "顯示名稱至少 2 個字元")
    .max(50, "顯示名稱最多 50 個字元")
    .regex(/^[a-zA-Z0-9_\u4e00-\u9fa5]+$/, "僅能包含字母、數字、中文或底線"),
  bio: z.string()
    .max(500, "個人簡介最多 500 個字元")
    .optional()
});
```

### State Management

**Profile Store (Zustand):**
```typescript
interface ProfileState {
  profile: UserProfile | null;
  loading: boolean;
  updateProfile: (data: Partial<UserProfile>) => Promise<void>;
  uploadAvatar: (file: File) => Promise<void>;
  addInterestTag: (tagId: number) => Promise<void>;
  removeInterestTag: (tagId: number) => Promise<void>;
}
```

---

## Tasks / Subtasks

### Task 1: 建立 Profile API Service (AC: 3, 4, 5, 6, 7)
- [ ] 1.1 創建 `src/services/profileService.ts`
- [ ] 1.2 實作所有 profile API 方法
- [ ] 1.3 實作 interest tags API 方法
- [ ] 1.4 處理 multipart/form-data 上傳

### Task 2: 建立 Profile Store (AC: 7)
- [ ] 2.1 創建 `src/store/profileStore.ts`
- [ ] 2.2 實作狀態和 actions
- [ ] 2.3 整合 API service

### Task 3: 建立通用 UI 元件 (AC: 2, 4, 5)
- [ ] 3.1 創建 `src/components/ui/Tabs.tsx` - Tab 導航
- [ ] 3.2 創建 `src/components/ui/FileUpload.tsx` - 檔案上傳
- [ ] 3.3 創建 `src/components/ui/TagSelector.tsx` - 標籤選擇
- [ ] 3.4 創建 `src/components/ui/Textarea.tsx` - 多行文字輸入

### Task 4: 實作 Tab 1 - 基本資料 (AC: 3, 7, 9)
- [ ] 4.1 創建 `src/components/profile/BasicInfoTab.tsx`
- [ ] 4.2 實作 React Hook Form 與 Zod 驗證
- [ ] 4.3 顯示名稱輸入框 (2-50字元驗證)
- [ ] 4.4 個人簡介輸入框 (0-500字元, 字數統計)
- [ ] 4.5 Email 顯示 (只讀)
- [ ] 4.6 儲存按鈕與即時錯誤提示
- [ ] 4.7 成功儲存 toast

### Task 5: 實作 Tab 2 - 頭像設定 (AC: 4, 7, 8, 9)
- [ ] 5.1 創建 `src/components/profile/AvatarTab.tsx`
- [ ] 5.2 顯示當前頭像 (或預設頭像)
- [ ] 5.3 檔案選擇與驗證 (類型、大小)
- [ ] 5.4 圖片預覽功能
- [ ] 5.5 上傳按鈕與 loading 狀態
- [ ] 5.6 移除頭像功能
- [ ] 5.7 成功/失敗 toast

### Task 6: 實作 Tab 3 - 興趣標籤 (AC: 5, 7, 9)
- [ ] 6.1 創建 `src/components/profile/InterestTagsTab.tsx`
- [ ] 6.2 載入並顯示所有可用標籤
- [ ] 6.3 顯示已選標籤 (可移除)
- [ ] 6.4 預設標籤選擇介面
- [ ] 6.5 自定義標籤輸入與創建
- [ ] 6.6 20個標籤限制驗證
- [ ] 6.7 新增/移除標籤即時更新
- [ ] 6.8 標籤長度驗證 (最多50字元)

### Task 7: 實作 Tab 4 - 隱私設定 (AC: 6, 7)
- [ ] 7.1 創建 `src/components/profile/PrivacyTab.tsx`
- [ ] 7.2 檔案可見性選項 (公開/好友/私密)
- [ ] 7.3 Email 顯示控制
- [ ] 7.4 讀書會顯示控制
- [ ] 7.5 儲存設定功能

### Task 8: 實作主頁面元件 (AC: 1, 2, 10)
- [ ] 8.1 創建 `src/pages/Profile.tsx`
- [ ] 8.2 整合 Tabs 元件
- [ ] 8.3 載入用戶檔案資料
- [ ] 8.4 組合所有 Tab 元件
- [ ] 8.5 實作響應式佈局
- [ ] 8.6 載入狀態處理

### Task 9: 配置路由 (AC: 1)
- [ ] 9.1 在 `src/App.tsx` 加入 `/profile` 路由
- [ ] 9.2 使用 `PrivateRoute` 保護
- [ ] 9.3 測試路由導航

### Task 10: 整合測試 (AC: All)
- [ ] 10.1 測試所有 Tab 切換
- [ ] 10.2 測試基本資料更新
- [ ] 10.3 測試頭像上傳與預覽
- [ ] 10.4 測試興趣標籤新增/移除
- [ ] 10.5 測試表單驗證
- [ ] 10.6 測試響應式佈局

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-21 | 1.0 | Initial frontend story creation | Scrum Master (Bob) |

---

## Dev Agent Record

_To be filled by Dev Agent_

---

## QA Results

_To be filled by QA Agent_
