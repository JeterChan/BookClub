# Story 2.4: 管理讀書會

**Status:** Ready for Review
**Epic:** Epic 2 - 讀書會管理與探索
**Story Points:** 8
**Priority:** 中
**Depends On:** Story 2.3

---

## Story

**作為** 一個讀書會的「擁有者」或「管理員」
**我想要** 編輯我管理的讀書會的資訊和成員
**以便於** 我可以更新社群的最新動態並維持社群品質

---

## Acceptance Criteria

1.  **AC1 - 修改讀書會資訊:** 擁有者/管理員可以在一個專屬的設定頁面修改讀書會的名稱、簡介、封面圖片和公開/私密狀態。
2.  **AC2 - 批准/拒絕加入請求:** 擁有者/管理員可以在設定頁面看到待處理的加入請求列表，並可以批准或拒絕這些請求。
3.  **AC3 - 管理成員角色:** 擁有者/管理員可以在設定頁面看到成員列表，並能將普通成員提升為管理員，或將管理員降級為普通成員。擁有者不能被降級。
4.  **AC4 - 移除成員:** 擁有者/管理員可以從成員列表中移除成員。擁有者不能被移除。
5.  **AC5 - 轉讓擁有權:** 只有擁有者可以看到「轉讓擁有權」的選項，並可將擁有權轉移給另一位成員。此操作需要二次確認。

---

## Tasks / Subtasks

### Task 1: Backend - 資料模型擴充
- [x] 1.1 在 `backend/app/models/book_club_member.py` 的 `BookClubMember` 模型中，確認 `role` 欄位是 `Enum` 型別，包含 `OWNER`, `ADMIN`, `MEMBER`。
- [x] 1.2 執行 `alembic revision --autogenerate -m "Update member roles"` 並檢查遷移腳本。
- [x] 1.3 執行 `alembic upgrade head`。

### Task 2: Backend - API Endpoints
- [x] 2.1 **(AC1)** 建立 `PUT /api/clubs/{club_id}` 端點，允許擁有者/管理員更新 `BookClub` 的基本資訊。需有權限檢查。
- [x] 2.2 **(AC2)** 建立 `GET /api/clubs/{club_id}/join-requests` 端點，獲取待處理的加入請求列表。
- [x] 2.3 **(AC2)** 建立 `POST /api/clubs/{club_id}/join-requests/{request_id}/approve` 端點來批准請求。
- [x] 2.4 **(AC2)** 建立 `POST /api/clubs/{club_id}/join-requests/{request_id}/reject` 端點來拒絕請求。
- [x] 2.5 **(AC3, AC4)** 建立 `GET /api/clubs/{club_id}/members` 端點，獲取成員列表及其角色。
- [x] 2.6 **(AC3)** 建立 `PUT /api/clubs/{club_id}/members/{user_id}/role` 端點，用於更新成員角色。
- [x] 2.7 **(AC4)** 建立 `DELETE /api/clubs/{club_id}/members/{user_id}` 端點，用於移除成員。
- [x] 2.8 **(AC5)** 建立 `POST /api/clubs/{club_id}/transfer-ownership` 端點，用於轉讓擁有權。

### Task 3: Backend - Service 層邏輯
- [x] 3.1 在 `book_club_service.py` (或新的 `club_management_service.py`) 中，為 Task 2 的每個端點實作對應的服務層邏輯，包含複雜的權限驗證（例如，只有擁有者能轉讓、管理員不能移除擁有者等）。

### Task 4: Frontend - 頁面與路由
- [x] 4.1 **(AC1-5)** 建立新的讀書會設定頁面 `frontend/src/pages/clubs/ClubSettings.tsx`。
- [x] 4.2 **(AC1-5)** 在 `frontend/src/App.tsx` 中新增路由 `/clubs/:clubId/settings`，並將其設為私密路由。
- [x] 4.3 在 `ClubDetail.tsx` 頁面，為擁有者/管理員顯示一個指向設定頁面的「管理」按鈕。

### Task 5: Frontend - Service 與 Store
- [x] 5.1 在 `frontend/src/services/` 中建立 `clubManagementService.ts`，為 Task 2 的所有新端點建立對應的 API 呼叫函式。
- [x] 5.2 建立 `frontend/src/store/clubManagementStore.ts` (或擴充 `bookClubStore`) 來管理設定頁面的狀態，包括成員列表、加入請求、表單資料、載入和錯誤狀態。

### Task 6: Frontend - UI 元件
- [x] 6.1 **(AC1)** 在 `ClubSettings.tsx` 中，建立一個表單來編輯讀書會資訊。
- [x] 6.2 **(AC2)** 在 `ClubSettings.tsx` 中，建立一個列表來顯示待處理的加入請求，並提供「批准」/「拒絕」按鈕。
- [x] 6.3 **(AC3, AC4)** 在 `ClubSettings.tsx` 中，建立一個成員列表，並為每位成員提供管理選項（改變角色、移除）。
- [x] 6.4 **(AC5)** 在 `ClubSettings.tsx` 中，為擁有者顯示「轉讓擁有權」的區塊，並包含二次確認的 Modal 對話框。

### Task 7: Frontend - 測試 (AC1, AC2, AC3, AC4)
- [x] 7.1 擴展 `frontend/src/pages/clubs/__tests__/ClubDetail.test.tsx`，測試不同成員狀態下的按鈕顯示與互動。
- [x] 7.2 擴展 `frontend/src/store/__tests__/bookClubStore.explore.test.ts` (或建立新檔案)，測試新的 store actions。

---

## Dev Notes

### Previous Story Insights
- **Authentication Token Handling**: Story 2.3 的開發揭示了 `localStorage` 與 `sessionStorage` 的處理不一致問題。所有新的 API 服務都必須從這兩個地方讀取 token，以確保身份驗證的穩定性。 [Source: Story 2.3 Dev Agent Record]
- **Owner vs. Member UI**: Story 2.3 的經驗表明，UI 必須明確區分擁有者和普通成員。在實作管理功能時，需要從 `useAuthStore` 獲取當前使用者資訊，並與成員角色進行比較，以決定是否渲染管理員專屬的 UI 元素。 [Source: Story 2.3 Dev Agent Record]

### Data Models
- **`BookClubMember`**: 此模型的 `role` 欄位將是本 Story 的核心。所有權限判斷都基於此欄位 (`OWNER`, `ADMIN`, `MEMBER`)。 [Source: `docs/architecture/2-後端架構詳細設計-sqlmodel.md`]
- **`ClubJoinRequest`**: 本 Story 將會更新此模型的 `status` 欄位，並在批准後於 `BookClubMember` 表中建立新紀錄。 [Source: `docs/architecture/2-後端架構詳細設計-sqlmodel.md`]

### API Specifications
- **`PUT /api/clubs/{club_id}`**:
  - **功能**: 更新讀書會資訊。
  - **認證**: 需要，且使用者必須是該讀書會的擁有者或管理員。
- **`GET /api/clubs/{club_id}/members`**:
  - **功能**: 獲取成員列表。
  - **認證**: 需要，建議只開放給成員查看。
- **`PUT /api/clubs/{club_id}/members/{user_id}/role`**:
  - **功能**: 變更成員角色。
  - **認證**: 需要，且執行者權限需高於目標使用者（例如擁有者可改管理員，管理員可改成員）。
- **`DELETE /api/clubs/{club_id}/members/{user_id}`**:
  - **功能**: 移除成員。
  - **認證**: 需要，且執行者權限需高於目標使用者。
- **`POST /api/clubs/{club_id}/transfer-ownership`**:
  - **功能**: 轉讓擁有權。
  - **認證**: 需要，且執行者必須是目前的擁有者。

### Component Specifications
- **`ClubSettings.tsx`**:
  - 這將是一個複雜的頁面，建議使用頁籤 (Tabs) 來分隔不同的管理功能區塊（例如：基本資訊、成員管理、加入請求）。
  - 頁面載入時需從後端獲取所有管理所需的資料（成員列表、請求列表）。
  - 所有操作都應有 `loading` 狀態反饋，並在完成或失敗時顯示 `toast` 通知。
- **`MemberListItem.tsx`**:
  - 建議為成員列表中的每一項建立一個子元件。
  - 此元件將根據傳入的成員角色和當前登入者的角色，來決定顯示哪些操作按鈕（例如，對一個普通成員顯示「設為管理員」、「移除」）。

### File Locations
- **Backend Services**: `backend/app/services/club_management_service.py` (建議新建)
- **Backend Endpoints**: `backend/app/api/endpoints/club_members.py` (建議新建)
- **Frontend Pages**: `frontend/src/pages/clubs/ClubSettings.tsx` (新建)
- **Frontend Services**: `frontend/src/services/clubManagementService.ts` (新建)
- **Frontend Store**: `frontend/src/store/clubManagementStore.ts` (新建)

### Testing Requirements
- **Backend**:
  - **權限測試**: 需為所有新端點撰寫整合測試，驗證權限控管是否正確。例如：普通成員不能存取任何管理端點；管理員不能移除擁有者；擁有者不能被移除或降級。
  - **業務邏輯測試**: 需為服務層的關鍵邏輯撰寫單元測試。例如：測試擁有權轉讓後，新舊擁有者的角色是否正確更新。
  - **邊界條件測試**: 測試批准一個已處理的請求、或操作一個不存在的成員時，系統是否能回傳正確的錯誤碼 (例如 404 或 409)。
- **Frontend**:
  - **條件渲染測試**: 在 `ClubDetail` 和 `ClubSettings` 頁面中，需 mock 不同的使用者角色（訪客、成員、管理員、擁有者），驗證 UI 元素（如「管理」按鈕、設定頁面內容）是否根據權限正確顯示或隱藏。
  - **互動測試**: 需測試所有管理操作的互動流程，包括表單提交、按鈕點擊、以及成功或失敗時的 `toast` 通知是否正常顯示。
  - **對話框測試**: 需測試「移除成員」和「轉讓擁有權」等危險操作的二次確認對話框是否能被正確觸發。

---
