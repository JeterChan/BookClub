# Story 2.3: 加入與退出讀書會

Status: Ready for Review
**Epic:** Epic 2 - 讀書會管理與探索
**Story Points:** 5
**Priority:** 高
**Depends On:** Story 2.2

---

## Story

**作為** 一個平台用戶
**我想要** 能夠加入公開的讀書會，或退出我已加入的讀書會
**以便於** 我可以靈活管理我的社群參與

---

## Acceptance Criteria

1.  **AC1 - 加入公開讀書會:** 在公開讀書會的詳細頁面 (`/clubs/:clubId`)，已登入用戶點擊「加入讀書會」按鈕後，應立即成為該讀書會的成員。按鈕應變為「已加入」或「退出讀書會」。
2.  **AC2 - 請求加入私密讀書會:** 在私密讀書會的詳細頁面，已登入用戶點擊「請求加入」按鈕後，系統應記錄此請求。按鈕應變為「已請求加入」的禁用狀態。
3.  **AC3 - 退出讀書會:** 對於已加入的讀書會，無論是公開或私密，用戶在詳細頁面點擊「退出讀書會」按鈕後，應被移除成員資格。按鈕應恢復為「加入讀書會」（如果公開）或「請求加入」（如果私密）。
4.  **AC4 - UI 反應:** 所有加入/退出/請求操作都應有即時的 UI 反饋（例如，按鈕狀態變更、成員數更新），並處理載入中和錯誤狀態。

---

## Tasks / Subtasks

### Task 1: Backend - 擴展資料模型 (AC2)
- [x] 1.1 在 `backend/app/models/` 中建立 `club_join_request.py` 檔案，定義 `ClubJoinRequest` 模型，包含 `id`, `book_club_id`, `user_id`, `status` ('pending', 'approved', 'rejected'), `created_at`, `updated_at` 欄位。
- [x] 1.2 執行 `alembic revision --autogenerate -m "Add club_join_request table"` 產生資料庫遷移腳本。
- [x] 1.3 執行 `alembic upgrade head` 套用遷移。

### Task 2: Backend - Service 層邏輯 (AC1, AC2, AC3)
- [x] 2.1 在 `backend/app/services/book_club_service.py` 新增 `join_book_club(club_id, user_id)` 函式，用於處理加入公開讀書會的邏輯 (在 `ClubMembership` 中建立紀錄)。
- [x] 2.2 在 `backend/app/services/book_club_service.py` 新增 `leave_book_club(club_id, user_id)` 函式，用於處理退出讀書會的邏輯 (刪除 `ClubMembership` 中的紀錄)。
- [x] 2.3 在 `backend/app/services/book_club_service.py` 新增 `request_to_join_book_club(club_id, user_id)` 函式，用於處理請求加入私密讀書會的邏輯 (在 `ClubJoinRequest` 中建立 'pending' 紀錄)。
- [x] 2.4 在 `get_book_club_by_id` 服務中擴展回傳資料，加入目前登入使用者的成員狀態（未加入、已加入、已請求）。

### Task 3: Backend - API Endpoints (AC1, AC2, AC3)
- [x] 3.1 在 `backend/app/api/endpoints/book_clubs.py` 中建立 `POST /api/clubs/{club_id}/join` 端點，呼叫 `join_book_club` 服務。
- [x] 3.2 在 `backend/app/api/endpoints/book_clubs.py` 中建立 `DELETE /api/clubs/{club_id}/leave` 端點，呼叫 `leave_book_club` 服務。
- [x] 3.3 在 `backend/app/api/endpoints/book_clubs.py` 中建立 `POST /api/clubs/{club_id}/request-join` 端點，呼叫 `request_to_join_book_club` 服務。
- [x] 3.4 保護所有新端點，確保使用者必須登入才能操作 (`Depends(get_current_active_user)`)。

### Task 4: Backend - 單元與整合測試 (AC1, AC2, AC3)
- [x] 4.1 為 `book_club_service.py` 中的新函式撰寫單元測試。
- [x] 4.2 為 `book_clubs.py` 中的新 API 端點撰寫整合測試，涵蓋成功、失敗、權限不足等情境。

### Task 5: Frontend - Service 與 Store (AC1, AC2, AC3, AC4)
- [x] 5.1 在 `frontend/src/services/bookClubService.ts` 中新增 `joinClub`, `leaveClub`, `requestToJoinClub` 函式。
- [x] 5.2 在 `frontend/src/store/bookClubStore.ts` 中新增對應的 actions (`joinClub`, `leaveClub`, `requestToJoinClub`) 來呼叫 service 函式並更新 `detailClub` 的狀態（例如成員數、使用者成員狀態）。

### Task 6: Frontend - UI 元件更新 (AC1, AC2, AC3, AC4)
- [x] 6.1 修改 `frontend/src/pages/clubs/ClubDetail.tsx` 中的按鈕邏輯。
- [x] 6.2 根據 `detailClub` 中的使用者成員狀態，動態顯示「加入讀書會」、「請求加入」、「退出讀書會」或「已請求加入」按鈕。
- [x] 6.3 為按鈕點擊事件綁定對應的 store actions，並處理 `loading` 和 `error` 狀態，提供使用者即時反饋。

### Task 7: Frontend - 測試 (AC1, AC2, AC3, AC4)
- [] 7.1 擴展 `frontend/src/pages/clubs/__tests__/ClubDetail.test.tsx`，測試不同成員狀態下的按鈕顯示與互動。
- [] 7.2 擴展 `frontend/src/store/__tests__/bookClubStore.explore.test.ts` (或建立新檔案)，測試新的 store actions。

---

## Dev Notes

### Previous Story Insights
- **API Naming Convention**: Story 2.2 的開發確立了 API 回應使用 `snake_case` 的慣例，以簡化後端與前端的整合。所有新的 API 端點和前端型別定義都應遵循此慣例。 [Source: Story 2.2 Dev Agent Record]

### Data Models
- **`ClubMembership`**: 此模型將被直接操作。加入讀書會即在此表新增一筆紀錄；退出則為刪除。 [Source: `docs/architecture/data-models.md`]
- **`ClubJoinRequest` (New)**: 為滿足 AC2（請求加入私密讀書會），需要一個新的資料模型來儲存請求狀態。建議模型欄位：`id`, `book_club_id` (FK), `user_id` (FK), `status` (enum: 'pending', 'approved', 'rejected'), `created_at`, `updated_at`。

### API Specifications
- **`POST /api/clubs/{club_id}/join`**:
  - **功能**: 加入一個公開讀書會。
  - **認證**: 需要。
  - **回應**: 成功時 `204 No Content`。
- **`DELETE /api/clubs/{club_id}/leave`**:
  - **功能**: 退出一個讀書會。
  - **認證**: 需要。
  - **回應**: 成功時 `204 No Content`。
- **`POST /api/clubs/{club_id}/request-join`**:
  - **功能**: 請求加入一個私密讀書會。
  - **認證**: 需要。
  - **回應**: 成功時 `201 Created`，返回建立的請求物件。
- **`GET /api/clubs/{club_id}` (擴展)**:
  - **功能**: 回應中需包含目前登入使用者的成員狀態，例如 `membership_status: "not_member" | "member" | "pending_request"`。

### Component Specifications
- **`ClubDetail.tsx`**:
  - 需從 `bookClubStore` 獲取 `detailClub` 的完整資訊，包含新的 `membership_status`。
  - 根據 `membership_status` 和讀書會的 `visibility` ('public' 或 'private') 來決定顯示哪個按鈕及其狀態。
  - 按鈕點擊後，應呼叫 store action，並在等待 API 回應時顯示 `loading` 狀態（例如，禁用按鈕並顯示 spinner）。

### File Locations
- **Backend Models**: `backend/app/models/club_join_request.py` (新建)
- **Backend Services**: `backend/app/services/book_club_service.py` (修改)
- **Backend Endpoints**: `backend/app/api/endpoints/book_clubs.py` (修改)
- **Backend Tests**: `backend/tests/unit/`, `backend/tests/integration/` (新增測試案例)
- **Frontend Services**: `frontend/src/services/bookClubService.ts` (修改)
- **Frontend Store**: `frontend/src/store/bookClubStore.ts` (修改)
- **Frontend Pages**: `frontend/src/pages/clubs/ClubDetail.tsx` (修改)
- **Frontend Tests**: `frontend/src/pages/clubs/__tests__/ClubDetail.test.tsx` (修改)

### Testing Requirements
- **Backend**: 需為所有 service 函式和 API 端點撰寫單元與整合測試，確保權限控管正確（例如，不能加入已滿或不存在的讀書會、不能重複加入等）。
- **Frontend**: 需在 `ClubDetail` 頁面的測試中，mock 不同的 `membership_status` 和 `visibility`，驗證按鈕的顯示和行為是否如預期。

---

## Change Log

| Date       | Version | Description                | Author |
|------------|---------|----------------------------|--------|
| 2025-10-25 | 1.0     | Initial draft of the story | Bob (sm) |

---

## Dev Agent Record
*(This section is populated by the development agent during implementation)*

### File List

**Frontend Files Created:**
1. `frontend/src/store/__tests__/bookClubStore.membership.test.ts`

**Frontend Files Modified:**
1. `frontend/src/services/bookClubService.ts`
2. `frontend/src/store/bookClubStore.ts`
3. `frontend/src/pages/clubs/__tests__/ClubDetail.test.tsx`

---

## QA Results
*(This section will be populated by the QA Agent after testing)*

**Frontend Files Created:**
1. `frontend/src/pages/clubs/__tests__/ClubDetail.test.tsx`
2. `frontend/src/store/__tests__/bookClubStore.membership.test.ts`

**Frontend Files Modified:**
1. `frontend/src/types/bookClub.ts`
2. `frontend/src/services/bookClubService.ts`
3. `frontend/src/store/bookClubStore.ts`
4. `frontend/src/pages/clubs/ClubDetail.tsx`
