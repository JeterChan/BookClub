# Story 3.1: 讀書進度追蹤

## Status
Draft

## Story
**As a** 一個讀書會的成員
**I want** 能夠追蹤並分享我對當前書籍的閱讀進度
**so that** 保持學習動力，並讓社群成員了解彼此的進度，促進同步討論

## Acceptance Criteria
1.  在讀書會頁面，成員可以更新他們對指定書籍的閱讀進度（透過頁數）。
2.  讀書會主頁應有一個視覺化的圖表或列表，展示所有成員的個人進度概覽。
3.  讀書會管理員可以設定當前書籍的總頁數。
4.  （可選）系統可以選擇性地向進度落後的成員發送友善的提醒通知。

## Tasks / Subtasks
- [ ] **後端 (Backend)**
    - [ ] **資料庫 (Database):**
        - [ ] **Alembic 遷移:** 建立一個新的遷移腳本，新增 `Book` 和 `BookProgress` 兩個資料表。 [AC: 1, 2, 3]
            - `alembic revision --autogenerate -m "Add book and book_progress models"`
    - [ ] **資料模型 (Models):**
        - [ ] 在 `app/models/` 中建立 `book.py`。 [AC: 3]
            - 定義 `Book` 模型，包含 `id`, `club_id` (FK to `book_club.id`), `title`, `total_pages`。
        - [ ] 在 `app/models/` 中建立 `book_progress.py`。 [AC: 1, 2]
            - 定義 `BookProgress` 模型，包含 `id`, `book_id` (FK to `book.id`), `user_id` (FK to `user.id`), `current_page`。
    - [ ] **API 端點 (Endpoints):**
        - [ ] **管理員設定書籍:** 在 `app/api/endpoints/clubs.py` 中新增 `PUT /api/v1/clubs/{club_id}/book` 端點，允許讀書會管理員設定或更新書籍資訊（特別是 `total_pages`）。 [AC: 3]
        - [ ] **更新進度:** 新增 `POST /api/v1/clubs/{club_id}/progress` 端點，讓成員可以提交自己的 `current_page`。 [AC: 1]
        - [ ] **獲取進度:** 新增 `GET /api/v1/clubs/{club_id}/progress` 端點，回傳該讀書會所有成員的進度列表。 [AC: 2]
- [ ] **前端 (Frontend)**
    - [ ] **API 服務 (Services):**
        - [ ] 在 `frontend/src/services/` 中建立 `clubService.ts` (如果尚不存在)，並新增上述三個 API 的請求函式。
    - [ ] **狀態管理 (State Management):**
        - [ ] 在 `frontend/src/store/slices/` 中建立 `clubSlice.ts`，用於管理讀書會詳細資訊，包括成員的進度。
    - [ ] **頁面與元件 (Pages & Components):**
        - [ ] **管理員介面:** 在 `frontend/src/pages/clubs/ClubSettings.tsx` 中，新增一個表單讓管理員可以設定書籍的總頁數。 [AC: 3]
        - [ ] **成員進度更新:** 在 `frontend/src/pages/clubs/ClubDetail.tsx` 中，新增一個輸入框和按鈕，讓成員可以更新他們的閱讀頁數。 [AC: 1]
        - [ ] **進度顯示:** 建立一個新的元件 `frontend/src/components/clubs/ProgressChart.tsx`，用來視覺化展示所有成員的進度（例如，使用條狀圖）。 [AC: 2]
        - [ ] 將 `ProgressChart.tsx` 元件整合到 `ClubDetail.tsx` 頁面中。
- [ ] **測試 (Testing)**
    - [ ] **後端:** 為新增的三個 API 端點撰寫 Pytest 單元測試。
    - [ ] **前端:** 為 `ProgressChart.tsx` 元件和相關的 Redux slice 撰寫 Vitest/RTL 單元測試。
    - [ ] **整合測試:** (根據 Story 1.7 QA 的回饋) 撰寫一個測試，模擬從前端更新進度到後端成功儲存的完整流程。

## Dev Notes
### Previous Story Insights
- **Testing:** Story 1.7 的 QA 結果指出專案缺乏整合測試。此 Story 的任務中已明確要求加入一個整合測試，以驗證前後端資料流。
- **Test Config:** 前端測試環境可能需要確認 `tsconfig.app.json` 中已加入 `"vitest/globals"`。

### Data Models
- **`Book` Model (`app/models/book.py`):**
  ```python
  from typing import Optional
  from sqlmodel import Field, SQLModel

  class BookBase(SQLModel):
      title: str
      total_pages: int

  class Book(BookBase, table=True):
      id: Optional[int] = Field(default=None, primary_key=True)
      club_id: int = Field(foreign_key="bookclub.id", unique=True) # Assuming one book per club for now
  ```
  - [Source: docs/architecture/2-後端架構詳細設計-sqlmodel.md]
- **`BookProgress` Model (`app/models/book_progress.py`):**
  ```python
  from typing import Optional
  from sqlmodel import Field, SQLModel

  class BookProgressBase(SQLModel):
      current_page: int

  class BookProgress(BookProgressBase, table=True):
      id: Optional[int] = Field(default=None, primary_key=True)
      book_id: int = Field(foreign_key="book.id")
      user_id: int = Field(foreign_key="user.id")
  ```
  - [Source: docs/architecture/2-後端架構詳細設計-sqlmodel.md]

### API Specifications
- `PUT /api/v1/clubs/{club_id}/book`: (Admin only)
    - **Request Body:** `{ "title": "The Pragmatic Programmer", "total_pages": 320 }`
    - **Response:** `200 OK` with the book object.
- `POST /api/v1/clubs/{club_id}/progress`: (Member only)
    - **Request Body:** `{ "current_page": 150 }`
    - **Response:** `200 OK` with the user's progress object.
- `GET /api/v1/clubs/{club_id}/progress`: (Member only)
    - **Response:** `200 OK` with a list of progress objects, e.g., `[{ "user_id": 1, "display_name": "John", "current_page": 150, "total_pages": 320 }, ...]`
- [Source: docs/architecture/2-後端架構詳細設計-sqlmodel.md#api-路由規劃]

### Component Specifications
- **`ProgressChart.tsx`:**
    - **Props:** `progressData: { userName: string; currentPage: number; totalPages: number; }[]`
    - **Render:** 應為每個用戶渲染一個條狀圖，顯示 `(currentPage / totalPages) * 100%` 的進度。
    - **Styling:** 使用 Tailwind CSS 來設計條狀圖樣式。
- [Source: docs/architecture/5-前端架構詳細設計-vite-react.md]

### File Locations
- **Backend Models:** `backend/app/models/book.py`, `backend/app/models/book_progress.py`
- **Backend API:** `backend/app/api/endpoints/clubs.py`
- **Frontend Page:** `frontend/src/pages/clubs/ClubDetail.tsx`, `frontend/src/pages/clubs/ClubSettings.tsx`
- **Frontend Component:** `frontend/src/components/clubs/ProgressChart.tsx`
- **Frontend State:** `frontend/src/store/slices/clubSlice.ts`
- [Source: docs/architecture/2-後端架構詳細設計-sqlmodel.md, docs/architecture/5-前端架構詳細設計-vite-react.md]
