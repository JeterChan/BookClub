# Story 4.3: 使用者個人檔案設定 - 上傳與管理個人頭像

### Status
Ready for Review

### Story
**身為** 一個平台會員，
**我想要** 在我的個人檔案設定頁面中，上傳、更換或移除我的大頭貼，
**如此一來** 我便可以進一步客製化我的帳號外觀，提升個人識別度。

### Acceptance Criteria
1.  在「個人檔案設定」頁面，使用者可以看到一個用於管理大頭貼的區塊。
2.  此區塊會顯示使用者目前的大頭貼。如果使用者沒有設定大頭貼，則顯示一個預設的圖示或圖片。
3.  提供一個「上傳新照片」按鈕，點擊後會開啟系統的檔案選擇視窗，並篩選圖片檔案（如 .jpg, .png）。
4.  使用者選擇圖片後，系統應顯示預覽（可選），並開始上傳。在上傳過程中，相關按鈕應顯示為載入中狀態。
5.  成功上傳後，頁面上的大頭貼和 `Header` 中的大頭貼應立即更新，無需重新整理頁面，並顯示成功的提示訊息。
6.  如果上傳失敗（例如，檔案過大、格式不符），則顯示錯誤的提示訊息。
7.  如果使用者已設定大頭貼，頁面會顯示一個「移除照片」按鈕。
8.  點擊「移除照片」按鈕時，會彈出一個確認視窗，詢問使用者是否確定要移除。
9.  在確認移除後，系統會呼叫移除大頭貼的服務，並在成功後將顯示的圖片還原為預設圖示，同時顯示成功的提示訊息。

### Tasks / Subtasks
- [x] **Task 1: 建立大頭貼管理區塊 UI (AC: #1, #2, #7)**
    - [x] 在 `profile/settings` 頁面新增一個區塊，用於顯示和管理大頭貼。
    - [x] 根據 `useAuthStore` 中的 `user.avatar_url` 顯示目前的大頭貼或預設圖示。
    - [x] 根據 `user.avatar_url` 的存在與否，條件性地顯示「上傳新照片」和「移除照片」按鈕。
- [x] **Task 2: 實作大頭貼上傳功能 (AC: #3, #4, #5, #6)**
    - [x] 為「上傳新照片」按鈕綁定點擊事件，觸發檔案選擇器。
    - [x] 實作前端檔案驗證邏輯，限制檔案類型 (image/png, image/jpeg) 和大小。
    - [x] 建立一個 `handleUpload` 函式，使用 `FormData` 來準備上傳的檔案。
    - [x] 呼叫 `profileService.uploadAvatar` (POST /api/users/me/avatar) 服務。
    - [x] 在上傳期間，顯示載入狀態並禁用相關按鈕。
    - [x] 上傳成功後，更新 `useAuthStore` 中的 `user` 狀態，並觸發成功通知。
    - [x] 處理並顯示上傳失敗時的錯誤訊息。
- [x] **Task 3: 實作大頭貼移除功能 (AC: #8, #9)**
    - [x] 為「移除照片」按鈕綁定點擊事件。
    - [x] 點擊後，使用現有的 `ConfirmationModal` 組件來要求使用者確認。
    - [x] 使用者確認後，呼叫 `profileService.removeAvatar` (DELETE /api/users/me/avatar) 服務。
    - [x] 移除成功後，更新 `useAuthStore` 中的 `user` 狀態，並觸發成功通知。

### Dev Notes
此故事基於 `4.2-user-profile-settings-basic-info.md` 所建立的「個人檔案設定」頁面。開發人員應確保新功能與現有頁面的風格和模式保持一致。

- **Relevant Source Tree:**
    - **修改:** `frontend/src/pages/Profile/SettingsPage.tsx` (假設)
    - **使用:** `frontend/src/services/profileService.ts`, `frontend/src/stores/useAuthStore.ts`, `frontend/src/components/ConfirmationModal.tsx`
- **Integration Points:**
    - **後端 API 端點:**
        - `POST /api/users/me/avatar`: 上傳大頭貼。使用 `multipart/form-data`。
        - `DELETE /api/users/me/avatar`: 移除大頭貼。
    - **前端狀態管理:**
        - 任何成功的操作（上傳/移除）都必須同步更新 `useAuthStore` 中的 `user.avatar_url` 狀態，以確保 UI (包括 Header) 的即時反應。
- **Key Constraints:**
    - 前端應對檔案大小和類型進行初步驗證，以改善使用者體驗。
    - 後端 API 應有完整的檔案驗證機制。
    - 移除操作必須有確認步驟，以防止意外刪除。

#### Testing
- **測試文件位置:** `frontend/tests/`
- **測試標準:**
    - 為新的 UI 互動和服務呼叫邏輯編寫單元測試或整合測試。
    - 驗證 `useAuthStore` 的狀態是否在操作成功後被正確更新。
    - 模擬 API 成功和失敗的回應，並驗證 UI 是否正確反應（例如，顯示成功/錯誤訊息）。
- **測試框架:** 遵循專案現有的測試框架和模式 (例如, Vitest, React Testing Library)。

### Change Log
| Date | Version | Description | Author |
|---|---|---|---|
| 2025-11-01 | 1.1 | 修復頭像顯示和刪除功能。 | James (Developer) |
| 2025-10-29 | 1.0 | 根據標準模板初始化故事文件。 | Bob (Scrum Master) |

### Dev Agent Record
*This section is populated by the development agent during implementation.*
- **Agent Model Used:** Gemini
- **Debug Log References:** None
- **Completion Notes List:**
  - 修復了頭像刪除功能。`profileService.ts` 中的 `removeAvatar` 現在會回傳更新後的使用者個人資料，確保狀態一致。`ProfileSettingsPage.tsx` 中的 `handleRemoveAvatar` 現在會使用回傳的資料來更新 `useAuthStore`。
  - 修復了頭像顯示問題。透過在 `ProfileSettingsPage.tsx` 中為圖片 URL 附加時間戳，解決了潛在的瀏覽器快取問題。
  - 修復了 `ProfileSettingsPage.tsx` 中的多個 linting 錯誤，包括一個由先前編輯引入的語法錯誤和一個指向錯誤函式名稱的 `onConfirm` 屬性。
- **File List:**
  - `modified: frontend/src/pages/profile/ProfileSettingsPage.tsx`
  - `modified: frontend/src/services/profileService.ts`
  - `deleted: frontend/src/pages/profile/__tests__/ProfileSettingsPage.test.tsx`

### QA Results

### Review Date: 2025-10-29

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

開發者成功地實作了所有功能需求。程式碼結構清晰，並遵循了現有的錯誤處理和使用者通知模式。然而，`ProfileSettingsPage` 組件現在管理著多個不同的狀態（基本資訊、上傳、移除），使其變得複雜且難以維護。

### Refactoring Performed

本次審查未執行任何重構，以避免在沒有自動化測試的情況下引入潛在的風險。

### Compliance Check

- Coding Standards: [✓]
- Project Structure: [✓]
- Testing Strategy: [✗] (根據使用者指示，測試被明確地豁免和移除。這是一個主要的技術債務。)
- All ACs Met: [✓]

### Improvements Checklist

- [ ] **高度建議**：將 `ProfileSettingsPage` 中的邏輯重構為多個自定義 Hooks (例如 `useBasicInfo`、`useAvatarManagement`)，以改善關注點分離 (Separation of Concerns) 並簡化組件。
- [ ] **必須**：為此功能建立一個統一的測試策略並補全測試案例，以防止未來的迴歸問題。

### Security Review

在前端對檔案類型和大小進行了驗證，這是一個好的實踐。沒有發現立即性的安全問題。

### Performance Considerations

目前的實作對性能影響不大。

### Gate Status

Gate: **WAIVED** → `docs/qa/gates/4.3-user-profile-settings-avatar.yml`

此決定的理由是，雖然缺乏自動化測試是一個重大缺失，但這是基於使用者為了解決測試環境問題而下達的明確指示。品質保證的責任轉移至手動測試。

### Recommended Status

[✓] Ready for Done (手動測試通過後)